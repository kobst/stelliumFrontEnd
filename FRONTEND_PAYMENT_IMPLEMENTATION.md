⏺ Frontend Migration Implementation Plan                                                                                                                                                                    
                                                                                                                                                                                                            
  Based on my review of the frontend specification and the backend implementation I just completed, here's a comprehensive implementation plan with corrections and clarifications.                         
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Key Discrepancies to Address                                                                                                                                                                              
                                                                                                                                                                                                            
  Before implementation, note these differences between the spec and actual backend:                                                                                                                        
  ┌──────────────────────────────────┬───────────────────────┬────────────────────────────────────────┐                                                                                                     
  │          Frontend Spec           │    Actual Backend     │                 Action                 │                                                                                                     
  ├──────────────────────────────────┼───────────────────────┼────────────────────────────────────────┤                                                                                                     
  │ plan: 'FREE' | 'PLUS'            │ plan: 'free' | 'plus' │ Normalize to uppercase in store        │                                                                                                     
  ├──────────────────────────────────┼───────────────────────┼────────────────────────────────────────┤                                                                                                     
  │ unlockedAnalyses in entitlements │ Separate endpoint     │ Fetch from /entitlements/unlocked      │                                                                                                     
  ├──────────────────────────────────┼───────────────────────┼────────────────────────────────────────┤                                                                                                     
  │ ownChartUnlocked field           │ Not directly provided │ Derive from unlocked list              │                                                                                                     
  ├──────────────────────────────────┼───────────────────────┼────────────────────────────────────────┤                                                                                                     
  │ Combined entitlements response   │ Split responses       │ Combine in store's fetchEntitlements() │                                                                                                     
  └──────────────────────────────────┴───────────────────────┴────────────────────────────────────────┘                                                                                                     
  ---                                                                                                                                                                                                       
  Phase 1: API Layer Setup                                                                                                                                                                                  
                                                                                                                                                                                                            
  1.1 Create API Client Functions                                                                                                                                                                           
                                                                                                                                                                                                            
  // api/entitlements.ts                                                                                                                                                                                    
                                                                                                                                                                                                            
  import { api } from './client';                                                                                                                                                                           
                                                                                                                                                                                                            
  export interface EntitlementsResponse {                                                                                                                                                                   
    plan: 'free' | 'plus';                                                                                                                                                                                  
    planActiveUntil: string | null;                                                                                                                                                                         
    analysesRemaining: number;                                                                                                                                                                              
    analysesBanked: number;                                                                                                                                                                                 
    analysesResetDate: string | null;                                                                                                                                                                       
    totalAnalysesAvailable: number;                                                                                                                                                                         
    questionsRemaining: number;                                                                                                                                                                             
    questionsResetDate: string | null;                                                                                                                                                                      
    purchasedQuestions: number;                                                                                                                                                                             
    totalQuestionsAvailable: number;                                                                                                                                                                        
    canAccessDailyHoroscope: boolean;                                                                                                                                                                       
    canAccessWeeklyHoroscope: boolean;                                                                                                                                                                      
    canAccessMonthlyHoroscope: boolean;                                                                                                                                                                     
    isSubscriptionActive: boolean;                                                                                                                                                                          
    hasEverBeenPlus: boolean;                                                                                                                                                                               
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  export interface UnlockedAnalysis {                                                                                                                                                                       
    entityType: 'BIRTH_CHART' | 'RELATIONSHIP';                                                                                                                                                             
    entityId: string;                                                                                                                                                                                       
    unlockMethod: 'PLUS_QUOTA' | 'PLUS_WELCOME' | 'PURCHASE';                                                                                                                                               
    unlockedAt: string;                                                                                                                                                                                     
    pricePaid: number | null;                                                                                                                                                                               
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  export interface AnalysisAccessResponse {                                                                                                                                                                 
    hasAccess: boolean;                                                                                                                                                                                     
    reason: 'UNLOCKED' | 'PLUS_QUOTA_AVAILABLE' | 'PURCHASABLE' | 'NEEDS_UNLOCK';                                                                                                                           
    quotaRemaining?: number;                                                                                                                                                                                
    bankedRemaining?: number;                                                                                                                                                                               
    purchasePrice?: number;                                                                                                                                                                                 
    plusPrice?: number;                                                                                                                                                                                     
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  export interface CheckoutResponse {                                                                                                                                                                       
    checkoutUrl: string;                                                                                                                                                                                    
    sessionId: string;                                                                                                                                                                                      
    price?: number;                                                                                                                                                                                         
    priceFormatted?: string;                                                                                                                                                                                
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  // API Functions                                                                                                                                                                                          
  export const entitlementsApi = {                                                                                                                                                                          
    getEntitlements: (userId: string) =>                                                                                                                                                                    
      api.get<{ success: boolean; entitlements: EntitlementsResponse }>(                                                                                                                                    
        `/users/${userId}/entitlements`                                                                                                                                                                     
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    getUnlockedAnalyses: (userId: string) =>                                                                                                                                                                
      api.get<{ success: boolean; unlocked: UnlockedAnalysis[] }>(                                                                                                                                          
        `/users/${userId}/entitlements/unlocked`                                                                                                                                                            
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    checkAnalysisAccess: (userId: string, entityType: string, entityId: string) =>                                                                                                                          
      api.post<{ success: boolean; access: AnalysisAccessResponse }>(                                                                                                                                       
        `/users/${userId}/entitlements/check-analysis`,                                                                                                                                                     
        { entityType, entityId }                                                                                                                                                                            
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    useAnalysis: (userId: string, entityType: string, entityId: string) =>                                                                                                                                  
      api.post<{ success: boolean; remaining: number; banked: number }>(                                                                                                                                    
        `/users/${userId}/entitlements/use-analysis`,                                                                                                                                                       
        { entityType, entityId }                                                                                                                                                                            
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    useQuestion: (userId: string) =>                                                                                                                                                                        
      api.post<{ success: boolean; source: string; monthlyRemaining: number; purchasedRemaining: number }>(                                                                                                 
        `/users/${userId}/entitlements/use-question`                                                                                                                                                        
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    initializeEntitlements: (userId: string) =>                                                                                                                                                             
      api.post<{ success: boolean; plan: string }>(                                                                                                                                                         
        `/users/${userId}/entitlements/initialize`                                                                                                                                                          
      ),                                                                                                                                                                                                    
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  export const checkoutApi = {                                                                                                                                                                              
    createSubscription: (userId: string, successUrl: string, cancelUrl: string) =>                                                                                                                          
      api.post<CheckoutResponse>(                                                                                                                                                                           
        `/users/${userId}/checkout/create-subscription`,                                                                                                                                                    
        { successUrl, cancelUrl }                                                                                                                                                                           
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    createPurchase: (                                                                                                                                                                                       
      userId: string,                                                                                                                                                                                       
      productType: 'BIRTH_CHART_360' | 'RELATIONSHIP_360' | 'QUESTION_PACK',                                                                                                                                
      entityId: string | null,                                                                                                                                                                              
      successUrl: string,                                                                                                                                                                                   
      cancelUrl: string                                                                                                                                                                                     
    ) =>                                                                                                                                                                                                    
      api.post<CheckoutResponse>(                                                                                                                                                                           
        `/users/${userId}/checkout/create-purchase`,                                                                                                                                                        
        { productType, entityId, successUrl, cancelUrl }                                                                                                                                                    
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    openPortal: (userId: string, returnUrl: string) =>                                                                                                                                                      
      api.post<{ portalUrl: string }>(                                                                                                                                                                      
        `/users/${userId}/checkout/portal`,                                                                                                                                                                 
        { returnUrl }                                                                                                                                                                                       
      ),                                                                                                                                                                                                    
                                                                                                                                                                                                            
    getProducts: () =>                                                                                                                                                                                      
      api.get<{ subscription: any; products: any[] }>('/checkout/products'),                                                                                                                                
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Phase 2: State Management                                                                                                                                                                                 
                                                                                                                                                                                                            
  2.1 Updated Entitlements Store                                                                                                                                                                            
                                                                                                                                                                                                            
  // stores/entitlementsStore.ts                                                                                                                                                                            
                                                                                                                                                                                                            
  import { create } from 'zustand';                                                                                                                                                                         
  import { entitlementsApi, checkoutApi } from '../api/entitlements';                                                                                                                                       
  import { useAuthStore } from './authStore';                                                                                                                                                               
                                                                                                                                                                                                            
  interface EntitlementsState {                                                                                                                                                                             
    // Data (normalized to uppercase for consistency)                                                                                                                                                       
    plan: 'FREE' | 'PLUS' | null;                                                                                                                                                                           
    planActiveUntil: Date | null;                                                                                                                                                                           
    isSubscriptionActive: boolean;                                                                                                                                                                          
                                                                                                                                                                                                            
    analyses: {                                                                                                                                                                                             
      remaining: number;                                                                                                                                                                                    
      banked: number;                                                                                                                                                                                       
      total: number;                                                                                                                                                                                        
      resetDate: Date | null;                                                                                                                                                                               
    } | null;                                                                                                                                                                                               
                                                                                                                                                                                                            
    questions: {                                                                                                                                                                                            
      monthly: number;                                                                                                                                                                                      
      purchased: number;                                                                                                                                                                                    
      total: number;                                                                                                                                                                                        
      resetDate: Date | null;                                                                                                                                                                               
    } | null;                                                                                                                                                                                               
                                                                                                                                                                                                            
    unlockedAnalyses: {                                                                                                                                                                                     
      birthCharts: string[];                                                                                                                                                                                
      relationships: string[];                                                                                                                                                                              
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    horoscopeAccess: {                                                                                                                                                                                      
      daily: boolean;                                                                                                                                                                                       
      weekly: boolean;                                                                                                                                                                                      
      monthly: boolean;                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    hasEverSubscribed: boolean;                                                                                                                                                                             
                                                                                                                                                                                                            
    // Loading state                                                                                                                                                                                        
    isLoading: boolean;                                                                                                                                                                                     
    error: string | null;                                                                                                                                                                                   
    lastFetched: Date | null;                                                                                                                                                                               
                                                                                                                                                                                                            
    // Actions                                                                                                                                                                                              
    fetchEntitlements: () => Promise<void>;                                                                                                                                                                 
    refreshAfterPurchase: () => Promise<void>;                                                                                                                                                              
    checkAndUseAnalysis: (entityType: 'BIRTH_CHART' | 'RELATIONSHIP', entityId: string) => Promise<boolean>;                                                                                                
    useQuestion: () => Promise<boolean>;                                                                                                                                                                    
    reset: () => void;                                                                                                                                                                                      
                                                                                                                                                                                                            
    // Computed helpers                                                                                                                                                                                     
    isPlusUser: () => boolean;                                                                                                                                                                              
    canAccessDailyHoroscope: () => boolean;                                                                                                                                                                 
    canAccess360Analysis: (entityType: 'BIRTH_CHART' | 'RELATIONSHIP', entityId: string) => boolean;                                                                                                        
    hasQuestionsRemaining: () => boolean;                                                                                                                                                                   
    getAnalysesAvailable: () => number;                                                                                                                                                                     
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  const initialState = {                                                                                                                                                                                    
    plan: null as 'FREE' | 'PLUS' | null,                                                                                                                                                                   
    planActiveUntil: null,                                                                                                                                                                                  
    isSubscriptionActive: false,                                                                                                                                                                            
    analyses: null,                                                                                                                                                                                         
    questions: null,                                                                                                                                                                                        
    unlockedAnalyses: { birthCharts: [], relationships: [] },                                                                                                                                               
    horoscopeAccess: { daily: false, weekly: true, monthly: true },                                                                                                                                         
    hasEverSubscribed: false,                                                                                                                                                                               
    isLoading: true,                                                                                                                                                                                        
    error: null,                                                                                                                                                                                            
    lastFetched: null,                                                                                                                                                                                      
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  export const useEntitlementsStore = create<EntitlementsState>((set, get) => ({                                                                                                                            
    ...initialState,                                                                                                                                                                                        
                                                                                                                                                                                                            
    fetchEntitlements: async () => {                                                                                                                                                                        
      const userId = useAuthStore.getState().user?.id;                                                                                                                                                      
      if (!userId) {                                                                                                                                                                                        
        set({ isLoading: false, error: 'No user logged in' });                                                                                                                                              
        return;                                                                                                                                                                                             
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      set({ isLoading: true, error: null });                                                                                                                                                                
                                                                                                                                                                                                            
      try {                                                                                                                                                                                                 
        // Fetch both entitlements and unlocked analyses in parallel                                                                                                                                        
        const [entitlementsRes, unlockedRes] = await Promise.all([                                                                                                                                          
          entitlementsApi.getEntitlements(userId),                                                                                                                                                          
          entitlementsApi.getUnlockedAnalyses(userId),                                                                                                                                                      
        ]);                                                                                                                                                                                                 
                                                                                                                                                                                                            
        const e = entitlementsRes.entitlements;                                                                                                                                                             
        const unlocked = unlockedRes.unlocked;                                                                                                                                                              
                                                                                                                                                                                                            
        // Categorize unlocked analyses                                                                                                                                                                     
        const birthCharts: string[] = [];                                                                                                                                                                   
        const relationships: string[] = [];                                                                                                                                                                 
                                                                                                                                                                                                            
        unlocked.forEach((item) => {                                                                                                                                                                        
          if (item.entityType === 'BIRTH_CHART') {                                                                                                                                                          
            birthCharts.push(item.entityId);                                                                                                                                                                
          } else {                                                                                                                                                                                          
            relationships.push(item.entityId);                                                                                                                                                              
          }                                                                                                                                                                                                 
        });                                                                                                                                                                                                 
                                                                                                                                                                                                            
        set({                                                                                                                                                                                               
          // Normalize plan to uppercase                                                                                                                                                                    
          plan: e.plan.toUpperCase() as 'FREE' | 'PLUS',                                                                                                                                                    
          planActiveUntil: e.planActiveUntil ? new Date(e.planActiveUntil) : null,                                                                                                                          
          isSubscriptionActive: e.isSubscriptionActive,                                                                                                                                                     
                                                                                                                                                                                                            
          analyses: {                                                                                                                                                                                       
            remaining: e.analysesRemaining,                                                                                                                                                                 
            banked: e.analysesBanked,                                                                                                                                                                       
            total: e.totalAnalysesAvailable,                                                                                                                                                                
            resetDate: e.analysesResetDate ? new Date(e.analysesResetDate) : null,                                                                                                                          
          },                                                                                                                                                                                                
                                                                                                                                                                                                            
          questions: {                                                                                                                                                                                      
            monthly: e.questionsRemaining,                                                                                                                                                                  
            purchased: e.purchasedQuestions,                                                                                                                                                                
            total: e.totalQuestionsAvailable,                                                                                                                                                               
            resetDate: e.questionsResetDate ? new Date(e.questionsResetDate) : null,                                                                                                                        
          },                                                                                                                                                                                                
                                                                                                                                                                                                            
          unlockedAnalyses: { birthCharts, relationships },                                                                                                                                                 
                                                                                                                                                                                                            
          horoscopeAccess: {                                                                                                                                                                                
            daily: e.canAccessDailyHoroscope,                                                                                                                                                               
            weekly: e.canAccessWeeklyHoroscope,                                                                                                                                                             
            monthly: e.canAccessMonthlyHoroscope,                                                                                                                                                           
          },                                                                                                                                                                                                
                                                                                                                                                                                                            
          hasEverSubscribed: e.hasEverBeenPlus,                                                                                                                                                             
          isLoading: false,                                                                                                                                                                                 
          lastFetched: new Date(),                                                                                                                                                                          
        });                                                                                                                                                                                                 
      } catch (error: any) {                                                                                                                                                                                
        console.error('[EntitlementsStore] Fetch error:', error);                                                                                                                                           
        set({                                                                                                                                                                                               
          error: error.message || 'Failed to fetch entitlements',                                                                                                                                           
          isLoading: false                                                                                                                                                                                  
        });                                                                                                                                                                                                 
      }                                                                                                                                                                                                     
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    refreshAfterPurchase: async () => {                                                                                                                                                                     
      // Add small delay to ensure webhook has processed                                                                                                                                                    
      await new Promise(resolve => setTimeout(resolve, 1000));                                                                                                                                              
      await get().fetchEntitlements();                                                                                                                                                                      
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    checkAndUseAnalysis: async (entityType, entityId) => {                                                                                                                                                  
      const userId = useAuthStore.getState().user?.id;                                                                                                                                                      
      if (!userId) return false;                                                                                                                                                                            
                                                                                                                                                                                                            
      try {                                                                                                                                                                                                 
        // First check if already unlocked (local check)                                                                                                                                                    
        if (get().canAccess360Analysis(entityType, entityId)) {                                                                                                                                             
          return true;                                                                                                                                                                                      
        }                                                                                                                                                                                                   
                                                                                                                                                                                                            
        // Use the analysis (this will consume quota if Plus user)                                                                                                                                          
        const result = await entitlementsApi.useAnalysis(userId, entityType, entityId);                                                                                                                     
                                                                                                                                                                                                            
        if (result.success) {                                                                                                                                                                               
          // Update local state                                                                                                                                                                             
          const { unlockedAnalyses, analyses } = get();                                                                                                                                                     
          const key = entityType === 'BIRTH_CHART' ? 'birthCharts' : 'relationships';                                                                                                                       
                                                                                                                                                                                                            
          set({                                                                                                                                                                                             
            unlockedAnalyses: {                                                                                                                                                                             
              ...unlockedAnalyses,                                                                                                                                                                          
              [key]: [...unlockedAnalyses[key], entityId],                                                                                                                                                  
            },                                                                                                                                                                                              
            analyses: analyses ? {                                                                                                                                                                          
              ...analyses,                                                                                                                                                                                  
              remaining: result.remaining,                                                                                                                                                                  
              banked: result.banked,                                                                                                                                                                        
              total: result.remaining + result.banked,                                                                                                                                                      
            } : null,                                                                                                                                                                                       
          });                                                                                                                                                                                               
                                                                                                                                                                                                            
          return true;                                                                                                                                                                                      
        }                                                                                                                                                                                                   
                                                                                                                                                                                                            
        return false;                                                                                                                                                                                       
      } catch (error) {                                                                                                                                                                                     
        console.error('[EntitlementsStore] Use analysis error:', error);                                                                                                                                    
        return false;                                                                                                                                                                                       
      }                                                                                                                                                                                                     
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    useQuestion: async () => {                                                                                                                                                                              
      const userId = useAuthStore.getState().user?.id;                                                                                                                                                      
      if (!userId) return false;                                                                                                                                                                            
                                                                                                                                                                                                            
      try {                                                                                                                                                                                                 
        const result = await entitlementsApi.useQuestion(userId);                                                                                                                                           
                                                                                                                                                                                                            
        if (result.success) {                                                                                                                                                                               
          const { questions } = get();                                                                                                                                                                      
          set({                                                                                                                                                                                             
            questions: questions ? {                                                                                                                                                                        
              ...questions,                                                                                                                                                                                 
              monthly: result.monthlyRemaining,                                                                                                                                                             
              purchased: result.purchasedRemaining,                                                                                                                                                         
              total: result.monthlyRemaining + result.purchasedRemaining,                                                                                                                                   
            } : null,                                                                                                                                                                                       
          });                                                                                                                                                                                               
          return true;                                                                                                                                                                                      
        }                                                                                                                                                                                                   
        return false;                                                                                                                                                                                       
      } catch (error) {                                                                                                                                                                                     
        console.error('[EntitlementsStore] Use question error:', error);                                                                                                                                    
        return false;                                                                                                                                                                                       
      }                                                                                                                                                                                                     
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    reset: () => set(initialState),                                                                                                                                                                         
                                                                                                                                                                                                            
    // Helpers                                                                                                                                                                                              
    isPlusUser: () => get().plan === 'PLUS' && get().isSubscriptionActive,                                                                                                                                  
                                                                                                                                                                                                            
    canAccessDailyHoroscope: () => get().horoscopeAccess.daily,                                                                                                                                             
                                                                                                                                                                                                            
    canAccess360Analysis: (entityType, entityId) => {                                                                                                                                                       
      const { unlockedAnalyses } = get();                                                                                                                                                                   
      const key = entityType === 'BIRTH_CHART' ? 'birthCharts' : 'relationships';                                                                                                                           
      return unlockedAnalyses[key].includes(entityId);                                                                                                                                                      
    },                                                                                                                                                                                                      
                                                                                                                                                                                                            
    hasQuestionsRemaining: () => (get().questions?.total ?? 0) > 0,                                                                                                                                         
                                                                                                                                                                                                            
    getAnalysesAvailable: () => get().analyses?.total ?? 0,                                                                                                                                                 
  }));                                                                                                                                                                                                      
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Phase 3: Checkout Hook                                                                                                                                                                                    
                                                                                                                                                                                                            
  3.1 Updated useCheckout Hook                                                                                                                                                                              
                                                                                                                                                                                                            
  // hooks/useCheckout.ts                                                                                                                                                                                   
                                                                                                                                                                                                            
  import { useState, useEffect } from 'react';                                                                                                                                                              
  import { useNavigate, useSearchParams } from 'react-router-dom';                                                                                                                                          
  import { toast } from 'react-hot-toast';                                                                                                                                                                  
  import { checkoutApi } from '../api/entitlements';                                                                                                                                                        
  import { useEntitlementsStore } from '../stores/entitlementsStore';                                                                                                                                       
  import { useAuthStore } from '../stores/authStore';                                                                                                                                                       
                                                                                                                                                                                                            
  export function useCheckout() {                                                                                                                                                                           
    const navigate = useNavigate();                                                                                                                                                                         
    const [searchParams] = useSearchParams();                                                                                                                                                               
    const { refreshAfterPurchase } = useEntitlementsStore();                                                                                                                                                
    const { user } = useAuthStore();                                                                                                                                                                        
    const [isLoading, setIsLoading] = useState(false);                                                                                                                                                      
                                                                                                                                                                                                            
    const userId = user?.id;                                                                                                                                                                                
                                                                                                                                                                                                            
    const startSubscription = async () => {                                                                                                                                                                 
      if (!userId) {                                                                                                                                                                                        
        toast.error('Please log in to subscribe');                                                                                                                                                          
        return;                                                                                                                                                                                             
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      setIsLoading(true);                                                                                                                                                                                   
      try {                                                                                                                                                                                                 
        const result = await checkoutApi.createSubscription(                                                                                                                                                
          userId,                                                                                                                                                                                           
          `${window.location.origin}/dashboard?upgraded=true`,                                                                                                                                              
          window.location.href                                                                                                                                                                              
        );                                                                                                                                                                                                  
        window.location.href = result.checkoutUrl;                                                                                                                                                          
      } catch (error: any) {                                                                                                                                                                                
        toast.error(error.message || 'Failed to start checkout');                                                                                                                                           
        setIsLoading(false);                                                                                                                                                                                
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    const purchaseAnalysis = async (                                                                                                                                                                        
      entityType: 'BIRTH_CHART' | 'RELATIONSHIP',                                                                                                                                                           
      entityId: string                                                                                                                                                                                      
    ) => {                                                                                                                                                                                                  
      if (!userId) {                                                                                                                                                                                        
        toast.error('Please log in to purchase');                                                                                                                                                           
        return;                                                                                                                                                                                             
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      setIsLoading(true);                                                                                                                                                                                   
      const productType = entityType === 'BIRTH_CHART'                                                                                                                                                      
        ? 'BIRTH_CHART_360'                                                                                                                                                                                 
        : 'RELATIONSHIP_360';                                                                                                                                                                               
                                                                                                                                                                                                            
      const returnPath = entityType === 'BIRTH_CHART'                                                                                                                                                       
        ? `/dashboard/charts/${entityId}`                                                                                                                                                                   
        : `/dashboard/relationships/${entityId}`;                                                                                                                                                           
                                                                                                                                                                                                            
      try {                                                                                                                                                                                                 
        const result = await checkoutApi.createPurchase(                                                                                                                                                    
          userId,                                                                                                                                                                                           
          productType,                                                                                                                                                                                      
          entityId,                                                                                                                                                                                         
          `${window.location.origin}${returnPath}?purchased=true`,                                                                                                                                          
          window.location.href                                                                                                                                                                              
        );                                                                                                                                                                                                  
        window.location.href = result.checkoutUrl;                                                                                                                                                          
      } catch (error: any) {                                                                                                                                                                                
        toast.error(error.message || 'Failed to start checkout');                                                                                                                                           
        setIsLoading(false);                                                                                                                                                                                
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    const purchaseQuestionPack = async () => {                                                                                                                                                              
      if (!userId) {                                                                                                                                                                                        
        toast.error('Please log in to purchase');                                                                                                                                                           
        return;                                                                                                                                                                                             
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      setIsLoading(true);                                                                                                                                                                                   
      try {                                                                                                                                                                                                 
        const result = await checkoutApi.createPurchase(                                                                                                                                                    
          userId,                                                                                                                                                                                           
          'QUESTION_PACK',                                                                                                                                                                                  
          null,                                                                                                                                                                                             
          `${window.location.origin}/dashboard?questions_purchased=true`,                                                                                                                                   
          window.location.href                                                                                                                                                                              
        );                                                                                                                                                                                                  
        window.location.href = result.checkoutUrl;                                                                                                                                                          
      } catch (error: any) {                                                                                                                                                                                
        toast.error(error.message || 'Failed to start checkout');                                                                                                                                           
        setIsLoading(false);                                                                                                                                                                                
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    const openCustomerPortal = async () => {                                                                                                                                                                
      if (!userId) {                                                                                                                                                                                        
        toast.error('Please log in');                                                                                                                                                                       
        return;                                                                                                                                                                                             
      }                                                                                                                                                                                                     
                                                                                                                                                                                                            
      try {                                                                                                                                                                                                 
        const result = await checkoutApi.openPortal(userId, window.location.href);                                                                                                                          
        window.location.href = result.portalUrl;                                                                                                                                                            
      } catch (error: any) {                                                                                                                                                                                
        toast.error(error.message || 'Failed to open portal');                                                                                                                                              
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    // Handle return from Stripe checkout                                                                                                                                                                   
    useEffect(() => {                                                                                                                                                                                       
      const upgraded = searchParams.get('upgraded');                                                                                                                                                        
      const purchased = searchParams.get('purchased');                                                                                                                                                      
      const questionsPurchased = searchParams.get('questions_purchased');                                                                                                                                   
                                                                                                                                                                                                            
      if (upgraded || purchased || questionsPurchased) {                                                                                                                                                    
        refreshAfterPurchase();                                                                                                                                                                             
                                                                                                                                                                                                            
        // Clean URL                                                                                                                                                                                        
        const newUrl = window.location.pathname;                                                                                                                                                            
        window.history.replaceState({}, '', newUrl);                                                                                                                                                        
                                                                                                                                                                                                            
        if (upgraded) {                                                                                                                                                                                     
          toast.success('Welcome to Plus! Your birth chart analysis is being generated.');                                                                                                                  
        } else if (purchased) {                                                                                                                                                                             
          toast.success('Purchase complete! Your analysis is being generated.');                                                                                                                            
        } else if (questionsPurchased) {                                                                                                                                                                    
          toast.success('Questions added to your account!');                                                                                                                                                
        }                                                                                                                                                                                                   
      }                                                                                                                                                                                                     
    }, [searchParams, refreshAfterPurchase]);                                                                                                                                                               
                                                                                                                                                                                                            
    return {                                                                                                                                                                                                
      isLoading,                                                                                                                                                                                            
      startSubscription,                                                                                                                                                                                    
      purchaseAnalysis,                                                                                                                                                                                     
      purchaseQuestionPack,                                                                                                                                                                                 
      openCustomerPortal,                                                                                                                                                                                   
    };                                                                                                                                                                                                      
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Phase 4: Core Components                                                                                                                                                                                  
                                                                                                                                                                                                            
  4.1 Files to Create                                                                                                                                                                                       
  ┌────────────────────────────────────────────────┬──────────────────────────────┐                                                                                                                         
  │                      File                      │         Description          │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ components/entitlements/PlanBadge.tsx          │ Shows FREE/PLUS badge in nav │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ components/entitlements/LockedOverlay.tsx      │ Gate for locked features     │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ components/entitlements/UpgradeModal.tsx       │ Plus subscription CTA        │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ components/entitlements/QuestionsIndicator.tsx │ Shows remaining questions    │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ components/entitlements/AnalysisQuotaCard.tsx  │ Shows available analyses     │                                                                                                                         
  ├────────────────────────────────────────────────┼──────────────────────────────┤                                                                                                                         
  │ hooks/useCheckout.ts                           │ Checkout flow handler        │                                                                                                                         
  └────────────────────────────────────────────────┴──────────────────────────────┘                                                                                                                         
  4.2 Updated LockedOverlay with Correct Pricing Logic                                                                                                                                                      
                                                                                                                                                                                                            
  // components/entitlements/LockedOverlay.tsx                                                                                                                                                              
                                                                                                                                                                                                            
  import { useEntitlementsStore } from '../../stores/entitlementsStore';                                                                                                                                    
  import { useCheckout } from '../../hooks/useCheckout';                                                                                                                                                    
                                                                                                                                                                                                            
  interface LockedOverlayProps {                                                                                                                                                                            
    feature: 'DAILY_HOROSCOPE' | '360_ANALYSIS' | 'ASK_STELLIUM';                                                                                                                                           
    entityType?: 'BIRTH_CHART' | 'RELATIONSHIP';                                                                                                                                                            
    entityId?: string;                                                                                                                                                                                      
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  export function LockedOverlay({ feature, entityType, entityId }: LockedOverlayProps) {                                                                                                                    
    const { isPlusUser, getAnalysesAvailable, checkAndUseAnalysis } = useEntitlementsStore();                                                                                                               
    const { startSubscription, purchaseAnalysis, isLoading } = useCheckout();                                                                                                                               
                                                                                                                                                                                                            
    const [isUnlocking, setIsUnlocking] = useState(false);                                                                                                                                                  
                                                                                                                                                                                                            
    const handleUseQuota = async () => {                                                                                                                                                                    
      if (!entityType || !entityId) return;                                                                                                                                                                 
      setIsUnlocking(true);                                                                                                                                                                                 
      const success = await checkAndUseAnalysis(entityType, entityId);                                                                                                                                      
      setIsUnlocking(false);                                                                                                                                                                                
      if (success) {                                                                                                                                                                                        
        toast.success('Analysis unlocked!');                                                                                                                                                                
      } else {                                                                                                                                                                                              
        toast.error('Failed to unlock analysis');                                                                                                                                                           
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    const getContent = () => {                                                                                                                                                                              
      switch (feature) {                                                                                                                                                                                    
        case 'DAILY_HOROSCOPE':                                                                                                                                                                             
          return {                                                                                                                                                                                          
            icon: <CalendarIcon />,                                                                                                                                                                         
            title: "Daily Horoscope",                                                                                                                                                                       
            description: "Get personalized daily guidance based on your chart",                                                                                                                             
            bullets: [                                                                                                                                                                                      
              "Tailored to your birth chart",                                                                                                                                                               
              "Updated every morning",                                                                                                                                                                      
              "Includes planetary influences"                                                                                                                                                               
            ],                                                                                                                                                                                              
            primaryCta: "Unlock with Plus ($20/mo)",                                                                                                                                                        
            primaryAction: startSubscription,                                                                                                                                                               
          };                                                                                                                                                                                                
                                                                                                                                                                                                            
        case '360_ANALYSIS':                                                                                                                                                                                
          const analysesAvailable = getAnalysesAvailable();                                                                                                                                                 
          const isPlus = isPlusUser();                                                                                                                                                                      
                                                                                                                                                                                                            
          // Pricing based on backend constants                                                                                                                                                             
          const price = entityType === 'BIRTH_CHART'                                                                                                                                                        
            ? (isPlus ? '$12' : '$20')                                                                                                                                                                      
            : (isPlus ? '$6' : '$10');                                                                                                                                                                      
                                                                                                                                                                                                            
          // Plus user with quota available                                                                                                                                                                 
          if (isPlus && analysesAvailable > 0) {                                                                                                                                                            
            return {                                                                                                                                                                                        
              icon: <SparklesIcon />,                                                                                                                                                                       
              title: "Generate 360° Analysis",                                                                                                                                                              
              description: `Use 1 of your ${analysesAvailable} available analyses`,                                                                                                                         
              bullets: [                                                                                                                                                                                    
                entityType === 'BIRTH_CHART'                                                                                                                                                                
                  ? "Complete personality profile"                                                                                                                                                          
                  : "Full relationship deep-dive",                                                                                                                                                          
                "All life themes & patterns",                                                                                                                                                               
                "Permanent access"                                                                                                                                                                          
              ],                                                                                                                                                                                            
              primaryCta: "Use Monthly Analysis",                                                                                                                                                           
              primaryAction: handleUseQuota,                                                                                                                                                                
            };                                                                                                                                                                                              
          }                                                                                                                                                                                                 
                                                                                                                                                                                                            
          // Plus user without quota                                                                                                                                                                        
          if (isPlus && analysesAvailable === 0) {                                                                                                                                                          
            return {                                                                                                                                                                                        
              icon: <LockIcon />,                                                                                                                                                                           
              title: "Unlock Full Analysis",                                                                                                                                                                
              description: "You've used your monthly analyses",                                                                                                                                             
              bullets: [                                                                                                                                                                                    
                entityType === 'BIRTH_CHART'                                                                                                                                                                
                  ? "Deep personality insights"                                                                                                                                                             
                  : "Comprehensive compatibility analysis",                                                                                                                                                 
                "40% Plus discount applied",                                                                                                                                                                
                "Permanent access"                                                                                                                                                                          
              ],                                                                                                                                                                                            
              primaryCta: `Purchase for ${price}`,                                                                                                                                                          
              primaryAction: () => purchaseAnalysis(entityType!, entityId!),                                                                                                                                
            };                                                                                                                                                                                              
          }                                                                                                                                                                                                 
                                                                                                                                                                                                            
          // Free user                                                                                                                                                                                      
          return {                                                                                                                                                                                          
            icon: <LockIcon />,                                                                                                                                                                             
            title: "Unlock Full Analysis",                                                                                                                                                                  
            description: entityType === 'BIRTH_CHART'                                                                                                                                                       
              ? "Deep dive into this birth chart"                                                                                                                                                           
              : "Explore this relationship in depth",                                                                                                                                                       
            bullets: [                                                                                                                                                                                      
              entityType === 'BIRTH_CHART'                                                                                                                                                                  
                ? "Identity, emotions, career & more"                                                                                                                                                       
                : "Harmony, passion, stability & more",                                                                                                                                                     
              "Permanent access",                                                                                                                                                                           
              "Subscribe to Plus for 40% off"                                                                                                                                                               
            ],                                                                                                                                                                                              
            primaryCta: `Purchase for ${price}`,                                                                                                                                                            
            primaryAction: () => purchaseAnalysis(entityType!, entityId!),                                                                                                                                  
            secondaryCta: "Subscribe to Plus",                                                                                                                                                              
            secondaryAction: startSubscription,                                                                                                                                                             
          };                                                                                                                                                                                                
                                                                                                                                                                                                            
        case 'ASK_STELLIUM':                                                                                                                                                                                
          return {                                                                                                                                                                                          
            icon: <ChatIcon />,                                                                                                                                                                             
            title: "Ask Stellium",                                                                                                                                                                          
            description: "Get AI-powered insights about this analysis",                                                                                                                                     
            bullets: [                                                                                                                                                                                      
              "Personalized answers",                                                                                                                                                                       
              "Based on your complete analysis"                                                                                                                                                             
            ],                                                                                                                                                                                              
            primaryCta: "Unlock 360° Analysis first",                                                                                                                                                       
            primaryAction: () => {                                                                                                                                                                          
              // Scroll or switch to 360 analysis tab                                                                                                                                                       
              document.getElementById('360-analysis-tab')?.click();                                                                                                                                         
            },                                                                                                                                                                                              
          };                                                                                                                                                                                                
      }                                                                                                                                                                                                     
    };                                                                                                                                                                                                      
                                                                                                                                                                                                            
    const content = getContent();                                                                                                                                                                           
    if (!content) return null;                                                                                                                                                                              
                                                                                                                                                                                                            
    return (                                                                                                                                                                                                
      <div className="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">                                                                          
        <div className="text-gray-400 mb-4">{content.icon}</div>                                                                                                                                            
        <h3 className="text-xl font-semibold mb-2">{content.title}</h3>                                                                                                                                     
        <p className="text-gray-600 mb-4 text-center">{content.description}</p>                                                                                                                             
                                                                                                                                                                                                            
        <ul className="mb-6 space-y-2">                                                                                                                                                                     
          {content.bullets.map((bullet, i) => (                                                                                                                                                             
            <li key={i} className="flex items-center gap-2 text-sm">                                                                                                                                        
              <CheckIcon className="w-4 h-4 text-green-500" />                                                                                                                                              
              {bullet}                                                                                                                                                                                      
            </li>                                                                                                                                                                                           
          ))}                                                                                                                                                                                               
        </ul>                                                                                                                                                                                               
                                                                                                                                                                                                            
        <Button                                                                                                                                                                                             
          onClick={content.primaryAction}                                                                                                                                                                   
          disabled={isLoading || isUnlocking}                                                                                                                                                               
          className="w-full max-w-xs"                                                                                                                                                                       
        >                                                                                                                                                                                                   
          {isLoading || isUnlocking ? <Spinner /> : content.primaryCta}                                                                                                                                     
        </Button>                                                                                                                                                                                           
                                                                                                                                                                                                            
        {content.secondaryCta && (                                                                                                                                                                          
          <Button                                                                                                                                                                                           
            variant="ghost"                                                                                                                                                                                 
            onClick={content.secondaryAction}                                                                                                                                                               
            className="mt-2"                                                                                                                                                                                
          >                                                                                                                                                                                                 
            {content.secondaryCta}                                                                                                                                                                          
          </Button>                                                                                                                                                                                         
        )}                                                                                                                                                                                                  
      </div>                                                                                                                                                                                                
    );                                                                                                                                                                                                      
  }                                                                                                                                                                                                         
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Phase 5: Integration Points                                                                                                                                                                               
                                                                                                                                                                                                            
  5.1 Initialize Entitlements on Auth                                                                                                                                                                       
                                                                                                                                                                                                            
  // In your auth flow (e.g., AuthProvider or useAuth hook)                                                                                                                                                 
                                                                                                                                                                                                            
  useEffect(() => {                                                                                                                                                                                         
    if (user && user.id) {                                                                                                                                                                                  
      // Initialize entitlements for new users (creates free tier if not exists)                                                                                                                            
      entitlementsApi.initializeEntitlements(user.id).catch(console.error);                                                                                                                                 
                                                                                                                                                                                                            
      // Fetch current entitlements                                                                                                                                                                         
      useEntitlementsStore.getState().fetchEntitlements();                                                                                                                                                  
    } else {                                                                                                                                                                                                
      // Reset on logout                                                                                                                                                                                    
      useEntitlementsStore.getState().reset();                                                                                                                                                              
    }                                                                                                                                                                                                       
  }, [user?.id]);                                                                                                                                                                                           
                                                                                                                                                                                                            
  5.2 Ask Stellium Integration                                                                                                                                                                              
                                                                                                                                                                                                            
  // In your Ask Stellium component                                                                                                                                                                         
                                                                                                                                                                                                            
  const { hasQuestionsRemaining, useQuestion } = useEntitlementsStore();                                                                                                                                    
                                                                                                                                                                                                            
  const handleAskQuestion = async (question: string) => {                                                                                                                                                   
    if (!hasQuestionsRemaining()) {                                                                                                                                                                         
      openQuestionPackModal();                                                                                                                                                                              
      return;                                                                                                                                                                                               
    }                                                                                                                                                                                                       
                                                                                                                                                                                                            
    // Deduct question BEFORE calling API                                                                                                                                                                   
    const success = await useQuestion();                                                                                                                                                                    
    if (!success) {                                                                                                                                                                                         
      toast.error('Failed to use question');                                                                                                                                                                
      return;                                                                                                                                                                                               
    }                                                                                                                                                                                                       
                                                                                                                                                                                                            
    try {                                                                                                                                                                                                   
      const response = await api.post('/ask-stellium', { question, context });                                                                                                                              
      // Handle response                                                                                                                                                                                    
    } catch (error) {                                                                                                                                                                                       
      // Consider refunding question on API error                                                                                                                                                           
      toast.error('Failed to get answer');                                                                                                                                                                  
    }                                                                                                                                                                                                       
  };                                                                                                                                                                                                        
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Phase 6: Migration Checklist                                                                                                                                                                              
                                                                                                                                                                                                            
  Files to Remove/Deprecate                                                                                                                                                                                 
                                                                                                                                                                                                            
  [ ] components/Credits/* (old credit display)                                                                                                                                                             
  [ ] components/Subscription/* (old subscription UI)                                                                                                                                                       
  [ ] hooks/useCredits.ts                                                                                                                                                                                   
  [ ] hooks/useSubscription.ts (old version)                                                                                                                                                                
  [ ] stores/creditsStore.ts                                                                                                                                                                                
  [ ] Any RevenueCat imports/hooks                                                                                                                                                                          
  [ ] Mobile IAP purchase flows                                                                                                                                                                             
                                                                                                                                                                                                            
  Files to Create                                                                                                                                                                                           
                                                                                                                                                                                                            
  [ ] api/entitlements.ts                                                                                                                                                                                   
  [ ] stores/entitlementsStore.ts                                                                                                                                                                           
  [ ] hooks/useCheckout.ts                                                                                                                                                                                  
  [ ] components/entitlements/PlanBadge.tsx                                                                                                                                                                 
  [ ] components/entitlements/LockedOverlay.tsx                                                                                                                                                             
  [ ] components/entitlements/UpgradeModal.tsx                                                                                                                                                              
  [ ] components/entitlements/QuestionsIndicator.tsx                                                                                                                                                        
  [ ] components/entitlements/AnalysisQuotaCard.tsx                                                                                                                                                         
                                                                                                                                                                                                            
  Files to Modify                                                                                                                                                                                           
                                                                                                                                                                                                            
  [ ] components/TopNav.tsx - Add PlanBadge                                                                                                                                                                 
  [ ] pages/Dashboard/Horoscope.tsx - Add daily lock                                                                                                                                                        
  [ ] pages/BirthChart/Profile.tsx - Add 360 lock                                                                                                                                                           
  [ ] pages/Relationship/Profile.tsx - Add 360 lock                                                                                                                                                         
  [ ] Any Ask Stellium components - Question gating                                                                                                                                                         
  [ ] AuthProvider or auth hooks - Initialize entitlements                                                                                                                                                  
                                                                                                                                                                                                            
  ---                                                                                                                                                                                                       
  Testing Checklist                                                                                                                                                                                         
                                                                                                                                                                                                            
  1. Free User Flow                                                                                                                                                                                         
    - Can see FREE badge in nav                                                                                                                                                                             
    - Daily horoscope shows locked overlay                                                                                                                                                                  
    - Can view weekly/monthly horoscopes                                                                                                                                                                    
    - 360 Analysis shows purchase option ($20/$10)                                                                                                                                                          
    - Ask Stellium shows "unlock 360 first" if analysis not unlocked                                                                                                                                        
    - Upgrade modal appears correctly                                                                                                                                                                       
  2. Plus User Flow                                                                                                                                                                                         
    - Can see PLUS badge in nav with "Manage" button                                                                                                                                                        
    - Daily horoscope accessible                                                                                                                                                                            
    - Can use monthly analysis quota                                                                                                                                                                        
    - Sees discounted prices when quota exhausted                                                                                                                                                           
    - Questions indicator shows monthly + purchased                                                                                                                                                         
    - Portal opens correctly                                                                                                                                                                                
  3. Checkout Flows                                                                                                                                                                                         
    - Subscription checkout redirects to Stripe                                                                                                                                                             
    - Return from subscription shows success toast                                                                                                                                                          
    - Purchase checkout redirects with correct price                                                                                                                                                        
    - Return from purchase shows success toast                                                                                                                                                              
    - Entitlements refresh after purchase                                                                                                                                                                   
  4. Edge Cases                                                                                                                                                                                             
    - Handles no user gracefully                                                                                                                                                                            
    - Handles API errors with toast                                                                                                                                                                         
    - Loading states show correctly                                                                                                                                                                         
    - Prevents double-clicks during checkout                                                                                                                                                                
                                                                                                                         